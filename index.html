<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مواقيت الصلاة</title>
  <style>
    body { font-family: "Cairo", sans-serif; text-align: center; background: #f0f0f0; color: #333; }
    h1 { color: #006400; }
    #times { margin-top: 20px; }
    .prayer { padding: 10px; margin: 5px; background: #fff; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <h1>🕌 مواقيت الصلاة</h1>
  <p id="status">⏳ جاري تحديد موقعك...</p>
  <div id="times"></div>

  <audio id="adhan-audio" src="https://download.tvquran.com/download/adhan/25/Adhan-Makkah.mp3"></audio>

  <script>
    // طلب إذن الإشعارات
    if ("Notification" in window) {
      Notification.requestPermission();
    }

    // دالة عرض إشعار
    function showNotification(title, body) {
      if (Notification.permission === "granted") {
        new Notification(title, { body });
      }
    }

    // جلب مواقيت الصلاة من API
    function fetchPrayerTimes(lat, lon) {
      const today = new Date();
      const url = `https://api.aladhan.com/v1/timings/${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}?latitude=${lat}&longitude=${lon}&method=2`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          document.getElementById("status").textContent = "✅ تم جلب مواقيت الصلاة";
          const timesDiv = document.getElementById("times");
          timesDiv.innerHTML = "";

          const timings = data.data.timings;
          const adhanAudio = document.getElementById("adhan-audio");

          Object.entries(timings).forEach(([name, time]) => {
            if (["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"].includes(name)) {
              const div = document.createElement("div");
              div.className = "prayer";
              div.innerHTML = `<b>${name}:</b> ${time}`;
              timesDiv.appendChild(div);

              // حساب وقت الصلاة
              const [hour, minute] = time.split(":").map(Number);
              const prayerTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour, minute, 0);

              // إشعار قبل الصلاة بـ 10 دقائق
              const beforeTime = new Date(prayerTime.getTime() - 10*60000);
              const now = new Date();

              if (beforeTime > now) {
                setTimeout(() => {
                  showNotification("⏳ تذكير", `باقي 10 دقائق على صلاة ${name}`);
                }, beforeTime - now);
              }

              // تشغيل صوت الأذان عند وقت الصلاة
              if (prayerTime > now) {
                setTimeout(() => {
                  showNotification("🕌 وقت الصلاة", `حان الآن وقت ${name}`);
                  adhanAudio.play();
                }, prayerTime - now);
              }
            }
          });
        })
        .catch(() => {
          document.getElementById("status").textContent = "❌ فشل في جلب المواقيت";
        });
    }

    // الحصول على الموقع
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          fetchPrayerTimes(pos.coords.latitude, pos.coords.longitude);
        },
        err => {
          document.getElementById("status").textContent = "⚠️ رجاءً فعّل إذن الموقع حتى يتم تحديد المواقيت.";
        }
      );
    } else {
      document.getElementById("status").textContent = "❌ المتصفح لا يدعم GPS";
    }
  </script>
</body>
</html>
